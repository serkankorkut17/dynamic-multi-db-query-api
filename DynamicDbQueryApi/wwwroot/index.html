<!doctype html>
<html lang="tr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Dynamic Query Console</title>
    <style>
      :root { color-scheme: light dark; font-family: system-ui, Arial, sans-serif; }
      body { margin: 1.25rem; line-height: 1.4; }
      h1 { margin-top: 0; }
      fieldset { border: 1px solid #777; padding: .75rem 1rem 1rem; margin-bottom: 1.25rem; }
      legend { font-weight: 600; padding: 0 .5rem; }
      label { display:block; font-size:.8rem; font-weight:600; text-transform:uppercase; letter-spacing:.05em; margin-top:.75rem; }
      input[type=text], textarea, select { width:100%; box-sizing:border-box; font:inherit; padding:.5rem; border:1px solid #666; border-radius:4px; background:var(--bg,inherit); }
      textarea { min-height:90px; resize:vertical; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
      .row { display:flex; flex-wrap:wrap; gap:1.25rem; }
      .col { flex:1 1 420px; min-width:320px; }
      button { cursor:pointer; padding:.55rem .95rem; font:inherit; border:1px solid #555; border-radius:4px; background:#1e6bd6; color:#fff; font-weight:600; display:inline-flex; align-items:center; gap:.4rem; }
      button.secondary { background:#555; }
      button:disabled { opacity:.55; cursor:progress; }
      pre { background:#1115; padding:.75rem 1rem; border-radius:6px; overflow:auto; max-height:340px; font-size:.78rem; }
      .outputs { display:flex; flex-wrap:wrap; gap:1.25rem; }
      .panel { flex:1 1 460px; min-width:320px; }
      .bad { color:#d33; font-weight:600; }
      .toolbar { display:flex; gap:.5rem; margin-top:.6rem; }
      small.hint { opacity:.75; font-weight:400; font-size:.65rem; display:block; margin-top:.2rem; }
      .badge { background:#444; color:#fff; padding:.15rem .45rem; border-radius:999px; font-size:.65rem; font-weight:600; letter-spacing:.05em; }
      .flex-end { display:flex; justify-content:flex-end; gap:.5rem; }
      hr { margin:2rem 0; border:none; border-top:1px solid #444; }
    </style>
  </head>
  <body>
    <h1>Dynamic Query Console</h1>
    <p>Ortak veritabanı bilgileriyle hem özel DSL sorgunu hem de ham SQL sorgunu çalıştır.</p>

    <form id="shared" onsubmit="return false;">
      <fieldset>
        <legend>Bağlantı Bilgileri</legend>
        <div class="row">
          <div class="col">
            <label for="dbType">DB Type</label>
            <select id="dbType">
              <option value="postgres">PostgreSQL</option>
              <option value="mysql">MySQL</option>
              <option value="mssql">SQL Server</option>
              <option value="oracle">Oracle</option>
            </select>
          </div>
        </div>
        <label for="conn">Connection String</label>
        <textarea id="conn" placeholder="Host=localhost;Port=5432;Database=querydb;Username=postgres;Password=postgres"></textarea>
      </fieldset>
    </form>

    <div class="row">
      <div class="col">
        <fieldset>
          <legend>DSL Query <span class="badge">/api/query</span></legend>
          <label for="dsl">Custom Sorgu</label>
          <textarea id="dsl" placeholder="FETCH(id, name) FILTER(age > 18 AND status = 'A') INCLUDE(orders) FROM users"></textarea>
          <div class="toolbar flex-end">
            <button type="button" id="runDsl">Çalıştır</button>
            <button type="button" class="secondary" id="clearDsl">Temizle</button>
          </div>
        </fieldset>
      </div>
      <div class="col">
        <fieldset>
          <legend>Raw SQL <span class="badge">/api/query/sql</span></legend>
          <label for="sql">SQL Sorgusu</label>
            <textarea id="sql" placeholder="SELECT id, name FROM users WHERE age > 18 ORDER BY id DESC LIMIT 20;"></textarea>
          <div class="toolbar flex-end">
            <button type="button" id="runSql">Çalıştır</button>
            <button type="button" class="secondary" id="clearSql">Temizle</button>
          </div>
        </fieldset>
      </div>
    </div>

    <hr />
    <div class="outputs">
      <div class="panel">
        <h3>DSL Sonuç</h3>
        <pre id="outDsl">(henüz yok)</pre>
      </div>
      <div class="panel">
        <h3>SQL Sonuç</h3>
        <pre id="outSql">(henüz yok)</pre>
      </div>
    </div>

    <hr />
    <fieldset>
      <legend>Karşılaştırma</legend>
      <div class="toolbar">
        <button type="button" id="compareBtn">Sonuçları Karşılaştır</button>
        <button type="button" class="secondary" id="clearCompare">Temizle</button>
      </div>
      <small class="hint">Karşılaştırma; primitive değerleri, dizileri ve nesneleri yapısal olarak kıyaslar. Nesne/dizi sırasını yok saymak için kanonikleştirilmiş karşılaştırma yapılır.</small>
      <pre id="outCompare">(henüz yok)</pre>
    </fieldset>

    <script>
      const el = id => document.getElementById(id);
      const btnDsl = el('runDsl');
      const btnSql = el('runSql');
      const outDsl = el('outDsl');
      const outSql = el('outSql');
  const outCompare = el('outCompare');
  const btnCompare = el('compareBtn');

  let lastDslData = undefined;
  let lastSqlData = undefined;

      function buildPayload(query) {
    return {
          dbType: el('dbType').value.trim(),
            connectionString: el('conn').value.trim(),
      query: query
        };
      }

      async function postJson(url, body) {
        const res = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(body) });
        const txt = await res.text();
        let data;
        try { data = JSON.parse(txt); } catch { data = txt; }
        if (!res.ok) throw data;
        return data;
      }

      function format(obj) {
        if (obj == null) return 'null';
        if (typeof obj === 'string') return obj;
        return JSON.stringify(obj, null, 2);
      }

      async function run(kind) {
        const isDsl = kind === 'dsl';
        const btn = isDsl ? btnDsl : btnSql;
        const area = isDsl ? el('dsl') : el('sql');
        const out = isDsl ? outDsl : outSql;
        const endpoint = isDsl ? '/api/query' : '/api/query/sql';
        const q = area.value.trim();
        if (!q) { out.textContent = 'Boş sorgu.'; return; }
        const payload = buildPayload(q);
        btn.disabled = true; out.textContent = 'Çalışıyor...';
        try {
          const data = await postJson(endpoint, payload);
          out.classList.remove('bad');
          if (isDsl && data && (data.sql || data.Sql)) {
            const sql = data.sql || data.Sql;
            const rows = data.data ?? data.Data;
            out.textContent = 'Generated SQL:\n' + sql + '\n\nResult:\n' + format(rows);
            lastDslData = rows;
          } else {
            out.textContent = format(data);
            if (isDsl) lastDslData = data; else lastSqlData = data;
          }
        } catch (e) {
          out.innerHTML = '' + format(e);
          out.classList.add('bad');
          if (isDsl) lastDslData = undefined; else lastSqlData = undefined;
        } finally { btn.disabled = false; }
      }

      function canonical(value) {
        if (value === null || typeof value !== 'object') return JSON.stringify(value);
        if (Array.isArray(value)) {
          // Array canonical: canonicalize each element then sort
          const mapped = value.map(v => canonical(v));
          mapped.sort();
          return '[' + mapped.join(',') + ']';
        }
        // Object canonical: sort keys
        const keys = Object.keys(value).sort();
        return '{' + keys.map(k => JSON.stringify(k) + ':' + canonical(value[k])).join(',') + '}';
      }

      function shallowSummary(arr) {
        if (!Array.isArray(arr)) return '';
        if (arr.length === 0) return '[]';
        const sample = arr[0];
        if (sample && typeof sample === 'object') {
          return 'rows=' + arr.length + ', cols={' + Object.keys(sample).join(',') + '}';
        }
        return 'items=' + arr.length;
      }

      function diffArrays(a, b) {
        const report = [];
        if (!Array.isArray(a) || !Array.isArray(b)) return report;
        if (a.length !== b.length) report.push(`Farklı satır sayısı: DSL=${a.length} SQL=${b.length}`);
        const len = Math.min(a.length, b.length);
        for (let i = 0; i < len; i++) {
          const ra = a[i];
            const rb = b[i];
            if (JSON.stringify(ra) !== JSON.stringify(rb)) {
              report.push(`Satır ${i} farkı (ilk fark gösteriliyor)`);
              report.push('DSL: ' + JSON.stringify(ra));
              report.push('SQL: ' + JSON.stringify(rb));
              break;
            }
        }
        return report;
      }

      function compareResults() {
        outCompare.classList.remove('bad');
        if (lastDslData === undefined || lastSqlData === undefined) {
          outCompare.textContent = 'Karşılaştırma için her iki sorguyu da önce çalıştır.';
          return;
        }
        try {
          const canonDsl = canonical(lastDslData);
          const canonSql = canonical(lastSqlData);
          const equal = canonDsl === canonSql;
          let lines = [];
          lines.push(equal ? 'SONUÇ: AYNI ✅' : 'SONUÇ: FARKLI ❌');
          if (!equal) {
            // Extra diagnostics for common shape (arrays of rows)
            if (Array.isArray(lastDslData) && Array.isArray(lastSqlData)) {
              lines.push('Özet DSL: ' + shallowSummary(lastDslData));
              lines.push('Özet SQL: ' + shallowSummary(lastSqlData));
              lines.push(...diffArrays(lastDslData, lastSqlData));
            }
          }
          outCompare.textContent = lines.join('\n');
        } catch (err) {
          outCompare.classList.add('bad');
          outCompare.textContent = 'Karşılaştırma hatası: ' + err;
        }
      }

      btnCompare.addEventListener('click', compareResults);
      el('clearCompare').addEventListener('click', () => { outCompare.textContent='(temizlendi)'; lastDslData = lastSqlData = undefined; });

      btnDsl.addEventListener('click', () => run('dsl'));
      btnSql.addEventListener('click', () => run('sql'));
      el('clearDsl').addEventListener('click', () => { el('dsl').value=''; outDsl.textContent='(temizlendi)'; });
      el('clearSql').addEventListener('click', () => { el('sql').value=''; outSql.textContent='(temizlendi)'; });

      // Quick fill for demo
      if(!el('conn').value) {
        el('conn').value = 'Host=localhost;Port=5432;Database=querydb;Username=postgres;Password=postgres';
      }
    </script>
  </body>
</html>
